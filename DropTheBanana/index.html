<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Drop the Banana!</title>
    <meta name="description" content="glTF Model - A-Frame">
    <script src="https://aframe.io/releases/1.0.4/aframe.min.js"></script>
    <script src="https://unpkg.com/aframe-particle-system-component@1.0.x/dist/aframe-particle-system-component.min.js"></script>
    <script src="//cdn.rawgit.com/donmccurdy/aframe-physics-system/v4.0.1/dist/aframe-physics-system.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/donmccurdy/aframe-extras@v6.1.1/dist/aframe-extras.min.js"></script>
    <script src="./js/play-all-model-animations.js"></script>
 <script>
   AFRAME.registerComponent('banana-bomb', {
     schema: {
       fired: {
         default: 0,
         type: 'int'
      }
     },
    init: function () {
  var data = this.data;
  //console.log(data)
  var bananaBomb = document.querySelector('#bananaBomb');

   bananaBomb.addEventListener('collide', function (e) {
   var fired = data.fired;
  if(e.detail.body.el.id.indexOf("customGorillaCollider" > -1) && fired==0) {
    var bananasplosion = document.querySelector('#bananaExploding');   
    console.log('Banana has collided with body #' + e.detail.body.el.id);
    data.fired = 1;
    bananasplosion.setAttribute("particle-system", {duration: 4, enabled:true});
    bananasplosion.components.sound.playSound();
  }
  
  /*
  e.detail.target.el;  // Original entity (playerEl).
  e.detail.body.el;    // Other entity, which playerEl touched.
  e.detail.contact;    // Stats about the collision (CANNON.ContactEquation).
  e.detail.contact.ni; // Normal (direction) of the collision (CANNON.Vec3).
  */


    });
  }
});

AFRAME.registerComponent('open-banana-door', {

  init: function () {
  var el = this.el;
  console.log(el.components)
  var dropperDoor = document.querySelector('#dropperDoor');

  dropperDoor.addEventListener('animationcomplete__2', function (e) {
   console.log("complete");
   dropperDoor.removeAttribute('static-body')
    });
  }
  
});
 </script>
  </head>
  <body>
    <a-scene stats  renderer="antialias: true;
    colorManagement: true;
    logarithmicDepthBuffer: true;"
    physics="friction: 0.1; restitution: 1">
      <a-assets>
        <a-asset-item id="blueGorilla" src="./models/blueGorilla.glb"></a-asset-item>
        <a-asset-item id="banana" src="./models/banana.glb"></a-asset-item> 

        <audio id="forestNight" src="audio/ForestNight.mp3" preload="auto"></audio>
        <audio id="explodingSound" src="audio/explosion.wav" preload="auto"></audio>

        <img id="forest" src="./images/forest.jpg">
        <img id="ground" src="./images/ground-diffuse.jpg">
        <img id="groundNormal" src="./images/ground-normal.jpg">
      </a-assets>
      <!-- 360 image sky-->
      <a-sky src="#forest" rotation="0 0 0"></a-sky>
<!--Background Music 
<a-entity sound="src: #forestNight; autoplay: true; volume:.1; rolloffFactor: 0; loop: true;"></a-entity>
-->

      <!-- Blue Gorilla, animated character model -->
      
      <a-entity gltf-model="#blueGorilla" animation-mixer position="0 0 -4"
    >
    <a-cylinder id="customGorillaCollider" position="0 .9 0" opacity="0" scale=".5 1.5 .5" static-body></a-cylinder>
  </a-entity>
   
      <!-- Banana -->
      <a-entity id="bananaBomb" banana-bomb dynamic-body gltf-model="#banana" scale=".01 .01 .01" position="0 7 -5" rotation="90 0 0">
        <!-- Banana-splosion! -->
      <a-entity scale="100 100 100" id="bananaExploding" particle-system="texture:./images/bananasplosion.png; maxAge:0.5; size:1; type:sphere; rotationAngle: -30; duration:4; dragValue: 5;
      dragSpread: 5; accelerationSpread: 50 50 50; accelerationValue: 0 0 0; velocityValue: 0 0 0; velocitySpread: 50 50 50; maxParticleCount: 250000;
      opacity:.8; color: #FFFF00; enabled: false;"
      sound="src: #explodingSound; autoplay: false; volume:1; rolloffFactor: 5; loop: false;"></a-entity>
      </a-entity>
     
      <!-- Banana dropper -->
      <a-entity id="bananaDropper">
      <a-box color="#654321" scale="1 15 1" position="2.9 6 -3"></a-box>
      <a-box color="#654321" scale="1 15 1" position="-2.9 6 -3"></a-box>
      <a-box id="dropperWall1"  static-body color="gray" opacity=".7" scale="6 .5 3" position="0 12 -3" rotation="-90 0 0"></a-box>
      <a-box id="dropperSideWall1"  color="gray" opacity="1" scale="4 .2 3" position="-2.9 12 -5" rotation="-90 90 0"></a-box>
      
      <a-box color="#654321" scale="1 15 1" position="2.9 6 -7"></a-box>
      <a-box color="#654321" scale="1 15 1" position="-2.9 6 -7"></a-box>
      <a-box id="dropperWall2"  static-body color="gray" opacity="1" scale="6 .5 3" position="0 12 -7" rotation="-90 0 0"></a-box>
      <a-box id="dropperSideWall2"  color="gray" opacity="1" scale="4 .2 3" position="2.9 12 -5" rotation="-90 90 0"></a-box>
      <a-box id="dropperDoor" animation="property: scale; to: 0 .5 4; dur: 1000; easing: linear; loop: false"  
      animation__2="property: position; to: -2.95 12 -5; dur: 1000; easing: linear; loop: false"  
      static-body color="lightblue" opacity=".5" scale="6 .5 4" position="0 12 -5" rotation="0 0 0"></a-box>

      <a-entity position="0 3 -2" text="font: https://cdn.aframe.io/fonts/mozillavr.fnt; value: Via stock font name."></a-entity>
      <a-cylinder color="red" open-banana-door position="2.9 1 -2.25" rotation="90 0 0" scale=".5 .5 .5" static-body></a-cylinder>
    </a-entity>
      <!-- Target ground-->
      <a-plane material="src:#ground; repeat: 100 100; normalMap: #groundNormal; normalTextureRepeat: 100 100; roughness:.7;" scale="100 100 100" rotation="-90 0 0" position="0 0 -3" static-body></a-plane>

      <a-entity
  geometry="primitive: plane; width: 4; height: auto"
  material="color: blue"
  text="value: This text will be 4 units wide."></a-entity>

    </a-scene>
  </body>
</html>
